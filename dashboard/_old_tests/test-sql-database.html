<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Database Test - Phase 1</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4ec9b0;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #dcdcaa;
            margin-top: 30px;
        }
        
        .status {
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .status.loading {
            background: #3a3a3a;
            border-left: 4px solid #dcdcaa;
        }
        
        .status.success {
            background: #1e3a1e;
            border-left: 4px solid #4ec9b0;
        }
        
        .status.error {
            background: #3a1e1e;
            border-left: 4px solid #f48771;
        }
        
        .code {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            background: #2d2d2d;
        }
        
        .test-result.pass {
            border-left: 3px solid #4ec9b0;
        }
        
        .test-result.fail {
            border-left: 3px solid #f48771;
        }
        
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
            margin: 5px;
        }
        
        button:hover {
            background: #1177bb;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #569cd6;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #4ec9b0;
        }
        
        .stat-label {
            font-size: 12px;
            color: #808080;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <h1>üóÑÔ∏è SQL Database - Phase 1 Test</h1>
    
    <div id="status" class="status loading">
        <strong>‚è≥ Initializing database...</strong>
        <p>Loading sql.js library and creating schema...</p>
    </div>
    
    <h2>Database Schema</h2>
    <div class="code">
        <pre>
<strong>ideas</strong> table:
  - id (INTEGER PRIMARY KEY)
  - text (TEXT)
  - project (TEXT)
  - ranking (INTEGER 1-5)
  - difficulty (easy/medium/hard)
  - status (new/backlog/done)
  - order (INTEGER)
  - timestamp (TEXT)
  - status_changed_at (TEXT)

<strong>projects</strong> table:
  - id (TEXT PRIMARY KEY)
  - name (TEXT UNIQUE)
  - priority (always-on/do-prep/getting-important/priority/urgent)
  - color (TEXT)
  - icon (TEXT)
        </pre>
    </div>
    
    <h2>Test Results</h2>
    <div id="test-results"></div>
    
    <h2>Database Statistics</h2>
    <div id="stats" class="stats"></div>
    
    <h2>Actions</h2>
    <button onclick="showRawData()">Show Raw Data (Console)</button>
    <button onclick="testQuery()">Test Query</button>
    <button onclick="runAllTests()">Run All Tests</button>
    
    <h2>Console Output</h2>
    <p>Check your browser console (F12) for detailed logs and test results.</p>
    
    <!-- Load sql.js from CDN -->
    <script src="https://sql.js.org/dist/sql-wasm.js"></script>
    
    <!-- Load our database layer -->
    <script src="sql-database.js"></script>
    
    <script>
        // Test runner
        async function runTests() {
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('test-results');
            const statsEl = document.getElementById('stats');
            
            try {
                // Initialize database
                await initializeDatabase();
                
                // Run tests
                const tests = [
                    { name: 'Database initialized', fn: () => db !== null },
                    { name: 'Ideas table exists', fn: () => {
                        const result = executeQuery("SELECT name FROM sqlite_master WHERE type='table' AND name='ideas'");
                        return result.length > 0;
                    }},
                    { name: 'Projects table exists', fn: () => {
                        const result = executeQuery("SELECT name FROM sqlite_master WHERE type='table' AND name='projects'");
                        return result.length > 0;
                    }},
                    { name: 'Indexes created', fn: () => {
                        const result = executeQuery("SELECT name FROM sqlite_master WHERE type='index'");
                        return result[0].values.length >= 4;
                    }},
                    { name: 'Can insert test data', fn: () => {
                        executeWrite('INSERT INTO ideas (text, project, ranking, difficulty, status, "order", timestamp) VALUES (?, ?, ?, ?, ?, ?, ?)',
                            ['Test idea', 'test', 3, 'medium', 'new', 0, new Date().toISOString()]);
                        return true;
                    }},
                    { name: 'Can query test data', fn: () => {
                        const results = queryAsObjects('SELECT * FROM ideas WHERE project = ?', ['test']);
                        return results.length > 0;
                    }},
                    { name: 'Can delete test data', fn: () => {
                        executeWrite('DELETE FROM ideas WHERE project = ?', ['test']);
                        const results = queryAsObjects('SELECT * FROM ideas WHERE project = ?', ['test']);
                        return results.length === 0;
                    }},
                    { name: 'Database saves to localStorage', fn: () => {
                        const saved = localStorage.getItem('management_system_sql_db');
                        return saved !== null;
                    }}
                ];
                
                let passed = 0;
                let failed = 0;
                
                resultsEl.innerHTML = '';
                
                for (const test of tests) {
                    try {
                        const result = test.fn();
                        if (result) {
                            passed++;
                            resultsEl.innerHTML += `<div class="test-result pass">‚úì ${test.name}</div>`;
                            console.log(`‚úì ${test.name}`);
                        } else {
                            failed++;
                            resultsEl.innerHTML += `<div class="test-result fail">‚úó ${test.name}</div>`;
                            console.error(`‚úó ${test.name}`);
                        }
                    } catch (error) {
                        failed++;
                        resultsEl.innerHTML += `<div class="test-result fail">‚úó ${test.name}: ${error.message}</div>`;
                        console.error(`‚úó ${test.name}:`, error);
                    }
                }
                
                // Show stats
                const stats = getDatabaseStats();
                statsEl.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.ideas || 0}</div>
                        <div class="stat-label">Total Ideas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.projects || 0}</div>
                        <div class="stat-label">Total Projects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.byStatus?.new || 0}</div>
                        <div class="stat-label">New Ideas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.byStatus?.backlog || 0}</div>
                        <div class="stat-label">Backlog</div>
                    </div>
                `;
                
                // Update status
                statusEl.className = 'status success';
                statusEl.innerHTML = `
                    <strong>‚úÖ Database initialized successfully!</strong>
                    <p>Tests passed: ${passed} / ${passed + failed}</p>
                    <p>Database is ready to use.</p>
                `;
                
                console.log('='.repeat(50));
                console.log('‚úÖ Phase 1 Complete!');
                console.log(`Tests: ${passed} passed, ${failed} failed`);
                console.log('='.repeat(50));
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.innerHTML = `
                    <strong>‚ùå Error initializing database</strong>
                    <p>${error.message}</p>
                `;
                console.error('‚ùå Database initialization failed:', error);
            }
        }
        
        function showRawData() {
            console.log('='.repeat(50));
            console.log('RAW DATABASE CONTENTS');
            console.log('='.repeat(50));
            const data = exportDatabaseAsJSON();
            console.log('Ideas:', data.ideas);
            console.log('Projects:', data.projects);
            console.log('Export date:', data.exportDate);
        }
        
        function testQuery() {
            console.log('='.repeat(50));
            console.log('TEST QUERY');
            console.log('='.repeat(50));
            
            try {
                const results = queryAsObjects('SELECT * FROM ideas LIMIT 5');
                console.log('Sample ideas:', results);
                alert(`Query successful! Found ${results.length} ideas. Check console for details.`);
            } catch (error) {
                console.error('Query failed:', error);
                alert(`Query failed: ${error.message}`);
            }
        }
        
        function runAllTests() {
            location.reload();
        }
        
        // Run tests on load
        runTests();
    </script>
</body>
</html>
