<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Migration Test - Phase 2</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 40px;
            max-width: 900px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4ec9b0;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #dcdcaa;
            margin-top: 30px;
        }
        
        .status {
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .status.ready {
            background: #2d2d2d;
            border-left: 4px solid #569cd6;
        }
        
        .status.running {
            background: #3a3a2d;
            border-left: 4px solid #dcdcaa;
        }
        
        .status.success {
            background: #1e3a1e;
            border-left: 4px solid #4ec9b0;
        }
        
        .status.error {
            background: #3a1e1e;
            border-left: 4px solid #f48771;
        }
        
        .warning {
            background: #3a3a2d;
            border-left: 4px solid #dcdcaa;
            padding: 15px;
            margin: 15px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .stats-section {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 5px;
        }
        
        .stats-section h3 {
            color: #569cd6;
            margin-top: 0;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #3a3a3a;
        }
        
        .stat-label {
            color: #808080;
        }
        
        .stat-value {
            color: #4ec9b0;
            font-weight: bold;
        }
        
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            margin: 5px;
        }
        
        button:hover:not(:disabled) {
            background: #1177bb;
        }
        
        button:disabled {
            background: #3a3a3a;
            color: #808080;
            cursor: not-allowed;
        }
        
        button.danger {
            background: #a1260d;
        }
        
        button.danger:hover:not(:disabled) {
            background: #c9301f;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .code {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .progress {
            margin: 20px 0;
        }
        
        .progress-bar {
            background: #3a3a3a;
            height: 30px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #0e639c, #1177bb);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üì¶ Data Migration - Phase 2</h1>
    
    <div id="status" class="status ready">
        <strong>Ready to migrate</strong>
        <p>This will copy your localStorage data into the SQL database.</p>
    </div>
    
    <div class="warning">
        <strong>‚ö†Ô∏è Safety Notes:</strong>
        <ul>
            <li>Your localStorage data will NOT be deleted</li>
            <li>A backup will be created before migration</li>
            <li>Both systems will run in parallel</li>
            <li>You can rollback if needed</li>
        </ul>
    </div>
    
    <h2>Current Data Status</h2>
    <div class="stats-grid" id="stats-before">
        <!-- Stats will load here -->
    </div>
    
    <h2>Migration Actions</h2>
    <div class="button-group">
        <button onclick="runMigration()" id="migrate-btn">
            üöÄ Start Migration
        </button>
        <button onclick="checkData()" id="check-btn">
            üîç Check Data
        </button>
        <button onclick="showBackups()" id="backups-btn">
            üìã List Backups
        </button>
        <button onclick="clearSQLData()" id="clear-btn" class="danger" disabled>
            üóëÔ∏è Clear SQL (Testing)
        </button>
    </div>
    
    <div id="progress" class="progress" style="display: none;">
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill">0%</div>
        </div>
    </div>
    
    <h2>Migration Results</h2>
    <div id="results"></div>
    
    <h2>Console Output</h2>
    <p>Check browser console (F12) for detailed migration logs.</p>
    
    <!-- Load dependencies -->
    <script src="https://sql.js.org/dist/sql-wasm.js"></script>
    <script src="sql-database.js"></script>
    <script src="migrate-to-sql.js"></script>
    
    <script>
        let migrationComplete = false;
        
        // Initialize on load
        async function init() {
            console.log('Initializing migration test page...');
            
            try {
                // Initialize database
                await initializeDatabase();
                
                // Show current data status
                await checkData();
                
                console.log('‚úÖ Page initialized');
                
            } catch (error) {
                console.error('Failed to initialize:', error);
                document.getElementById('status').className = 'status error';
                document.getElementById('status').innerHTML = `
                    <strong>‚ùå Initialization failed</strong>
                    <p>${error.message}</p>
                `;
            }
        }
        
        async function checkData() {
            console.log('Checking data status...');
            
            const statsContainer = document.getElementById('stats-before');
            
            // Get localStorage data
            const localIdeasJSON = localStorage.getItem('management_system_ideas');
            const localProjectsJSON = localStorage.getItem('management_system_projects');
            
            const localIdeas = localIdeasJSON ? JSON.parse(localIdeasJSON) : [];
            const localProjects = localProjectsJSON ? JSON.parse(localProjectsJSON) : [];
            
            // Get SQL data
            const sqlStats = getDatabaseStats();
            
            statsContainer.innerHTML = `
                <div class="stats-section">
                    <h3>üì¶ localStorage (Current)</h3>
                    <div class="stat-row">
                        <span class="stat-label">Ideas:</span>
                        <span class="stat-value">${localIdeas.length}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Projects:</span>
                        <span class="stat-value">${localProjects.length}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">New:</span>
                        <span class="stat-value">${localIdeas.filter(i => i.status === 'new').length}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Backlog:</span>
                        <span class="stat-value">${localIdeas.filter(i => i.status === 'backlog').length}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Done:</span>
                        <span class="stat-value">${localIdeas.filter(i => i.status === 'done').length}</span>
                    </div>
                </div>
                
                <div class="stats-section">
                    <h3>üóÑÔ∏è SQL Database</h3>
                    <div class="stat-row">
                        <span class="stat-label">Ideas:</span>
                        <span class="stat-value">${sqlStats.ideas || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Projects:</span>
                        <span class="stat-value">${sqlStats.projects || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">New:</span>
                        <span class="stat-value">${sqlStats.byStatus?.new || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Backlog:</span>
                        <span class="stat-value">${sqlStats.byStatus?.backlog || 0}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Done:</span>
                        <span class="stat-value">${sqlStats.byStatus?.done || 0}</span>
                    </div>
                </div>
            `;
            
            // Enable clear button if SQL has data
            if (sqlStats.ideas > 0 || sqlStats.projects > 0) {
                document.getElementById('clear-btn').disabled = false;
            }
        }
        
        async function runMigration() {
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            const progressEl = document.getElementById('progress');
            const progressFill = document.getElementById('progress-fill');
            const migrateBtn = document.getElementById('migrate-btn');
            
            // Disable button
            migrateBtn.disabled = true;
            
            // Show progress
            progressEl.style.display = 'block';
            progressFill.style.width = '10%';
            progressFill.textContent = 'Starting...';
            
            // Update status
            statusEl.className = 'status running';
            statusEl.innerHTML = `
                <strong>‚è≥ Migration in progress...</strong>
                <p>Copying data from localStorage to SQL database...</p>
            `;
            
            console.log('Starting migration...');
            
            try {
                progressFill.style.width = '30%';
                progressFill.textContent = 'Creating backup...';
                
                // Run migration
                const result = await migrateToSQL();
                
                progressFill.style.width = '100%';
                progressFill.textContent = 'Complete!';
                
                if (result.success) {
                    migrationComplete = true;
                    
                    statusEl.className = 'status success';
                    statusEl.innerHTML = `
                        <strong>‚úÖ Migration complete!</strong>
                        <p>Duration: ${result.duration} seconds</p>
                    `;
                    
                    resultsEl.innerHTML = `
                        <div class="stats-section">
                            <h3>‚úÖ Migration Summary</h3>
                            <div class="stat-row">
                                <span class="stat-label">Projects migrated:</span>
                                <span class="stat-value">${result.migrated.projects}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Ideas migrated:</span>
                                <span class="stat-value">${result.migrated.ideas}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Duration:</span>
                                <span class="stat-value">${result.duration}s</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Backup:</span>
                                <span class="stat-value" style="font-size: 10px;">${result.backup}</span>
                            </div>
                        </div>
                        
                        <div class="warning" style="background: #1e3a1e; border-color: #4ec9b0;">
                            <strong>‚úÖ Verification</strong>
                            <p>localStorage ideas: ${result.verification.localStorage.ideas}</p>
                            <p>SQL ideas: ${result.verification.sql.ideas}</p>
                            <p>Match: ${result.verification.match.ideas ? '‚úì' : '‚úó'}</p>
                        </div>
                    `;
                    
                } else {
                    statusEl.className = 'status error';
                    statusEl.innerHTML = `
                        <strong>‚ùå Migration failed</strong>
                        <p>${result.error}</p>
                    `;
                    
                    resultsEl.innerHTML = `
                        <div class="status error">
                            <strong>Error Details:</strong>
                            <pre>${result.stack}</pre>
                        </div>
                    `;
                }
                
                // Refresh data display
                await checkData();
                
                // Hide progress after a moment
                setTimeout(() => {
                    progressEl.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Migration error:', error);
                
                statusEl.className = 'status error';
                statusEl.innerHTML = `
                    <strong>‚ùå Migration error</strong>
                    <p>${error.message}</p>
                `;
                
                progressEl.style.display = 'none';
            }
        }
        
        function showBackups() {
            listBackups();
            alert('Check console for backup list');
        }
        
        async function clearSQLData() {
            if (!confirm('Clear all SQL data? This is for testing only. Your localStorage is safe.')) {
                return;
            }
            
            console.log('Clearing SQL database...');
            clearDatabase();
            
            await checkData();
            
            alert('SQL database cleared. localStorage is untouched.');
            document.getElementById('clear-btn').disabled = true;
        }
        
        // Initialize on load
        init();
    </script>
</body>
</html>
