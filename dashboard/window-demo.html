<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Win3x Window Behavior Demo</title>
    <link rel="stylesheet" href="win3x-theme.css">
    <link rel="stylesheet" href="win3x-skin-3.1.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui;
        }

        /* Desktop container - windows operate within this boundary */
        .desktop-container {
            background: var(--desktop-bg);
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* Minimized window icon - sits directly on desktop */
        .window-icon {
            position: absolute;
            width: 100px;
            height: 32px;
            background: var(--button-bg);
            border: 1px solid var(--border);
            box-shadow: inset -1px -1px 0 var(--button-dark),
                        inset 1px 1px 0 var(--button-light);
            display: flex;
            align-items: center;
            padding: 2px 4px;
            cursor: pointer;
            font-size: 11px;
            user-select: none;
        }

        .window-icon:active {
            box-shadow: inset 1px 1px 0 var(--button-dark);
        }

        .window-icon .icon-symbol {
            width: 16px;
            height: 14px;
            background: var(--button-bg);
            border: 1px solid var(--border);
            box-shadow: inset -1px -1px 0 var(--button-dark),
                        inset 1px 1px 0 var(--button-light);
            margin-right: 4px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .window-icon .icon-symbol::after {
            content: '';
            width: 8px;
            height: 2px;
            background: var(--window-fg);
        }

        .window-icon .icon-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .window-icon.dragging {
            opacity: 0.7;
            z-index: 9999;
        }

        /* Status bar at bottom of window */
        .status-bar {
            display: flex;
            align-items: center;
            background: var(--button-bg);
            border: 1px solid var(--border);
            border-top: 0;
            height: 20px;
            padding: 0 2px;
            font-size: 11px;
        }

        .status-bar-section {
            padding: 0 8px;
            border-right: 1px solid var(--button-dark);
            box-shadow: 1px 0 0 var(--button-light);
            height: 100%;
            display: flex;
            align-items: center;
        }

        .status-bar-section:last-child:not(.sizing-grip) {
            flex: 1;
            border-right: none;
            box-shadow: none;
        }

        /* Sizing grip - diagonal lines in corner */
        .sizing-grip {
            width: 16px;
            height: 16px;
            margin-left: auto;
            cursor: se-resize;
            background: var(--button-bg);
            position: relative;
            flex-shrink: 0;
        }

        .sizing-grip::before {
            content: '';
            position: absolute;
            right: 2px;
            bottom: 2px;
            width: 10px;
            height: 10px;
            background:
                linear-gradient(135deg,
                    transparent 0%, transparent 30%,
                    var(--button-dark) 30%, var(--button-dark) 40%,
                    transparent 40%, transparent 50%,
                    var(--button-dark) 50%, var(--button-dark) 60%,
                    transparent 60%, transparent 70%,
                    var(--button-dark) 70%, var(--button-dark) 80%,
                    transparent 80%, transparent 100%
                );
        }

        /* Custom scrollbar container for explicit scrollbars */
        .scrollable-area {
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .scroll-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            height: 100%;
        }

        .scroll-viewport {
            position: absolute;
            top: 0;
            left: 0;
            right: 17px;
            bottom: 17px;
            overflow: hidden;
            background: var(--window-bg);
        }

        .scroll-inner {
            padding: 8px;
        }

        /* Vertical scrollbar */
        .scrollbar-v {
            position: absolute;
            top: 0;
            right: 0;
            width: 17px;
            bottom: 17px;
            display: flex;
            flex-direction: column;
            background: var(--scrollbar-bg);
            border-left: 1px solid var(--border);
        }

        /* Horizontal scrollbar */
        .scrollbar-h {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 17px;
            height: 17px;
            display: flex;
            flex-direction: row;
            background: var(--scrollbar-bg);
            border-top: 1px solid var(--border);
        }

        /* Scrollbar buttons */
        .scroll-btn {
            width: 16px;
            height: 16px;
            background: var(--button-bg);
            border: 1px solid var(--border);
            box-shadow: inset 1px 1px 0 var(--button-light),
                        inset -2px -2px 0 var(--button-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .scroll-btn:active {
            box-shadow: inset 1px 1px 0 var(--button-dark);
        }

        .scroll-btn:active .scroll-arrow {
            transform: translate(1px, 1px);
        }

        /* Arrow icons - CSS triangles matching Win 3.1 style */
        .scroll-arrow {
            width: 0;
            height: 0;
            border: 5px solid transparent;
        }

        .scroll-arrow.up {
            border-bottom: 5px solid var(--window-fg);
            border-top: none;
        }

        .scroll-arrow.down {
            border-top: 5px solid var(--window-fg);
            border-bottom: none;
        }

        .scroll-arrow.left {
            border-right: 5px solid var(--window-fg);
            border-left: none;
        }

        .scroll-arrow.right {
            border-left: 5px solid var(--window-fg);
            border-right: none;
        }

        /* Scrollbar track */
        .scroll-track {
            flex: 1;
            background: var(--scrollbar-bg);
            position: relative;
            min-height: 16px;
            min-width: 16px;
        }

        /* Scrollbar thumb */
        .scroll-thumb {
            position: absolute;
            background: var(--button-bg);
            border: 1px solid var(--border);
            box-shadow: inset 1px 1px 0 var(--button-light),
                        inset -2px -2px 0 var(--button-dark);
            cursor: pointer;
        }

        .scroll-thumb:active {
            box-shadow: inset 1px 1px 0 var(--button-dark);
        }

        .scrollbar-v .scroll-thumb {
            left: 0;
            right: 0;
            min-height: 16px;
        }

        .scrollbar-h .scroll-thumb {
            top: 0;
            bottom: 0;
            min-width: 16px;
        }

        /* Corner piece where scrollbars meet */
        .scroll-corner {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 17px;
            height: 17px;
            background: var(--button-bg);
            border-left: 1px solid var(--border);
            border-top: 1px solid var(--border);
        }

        /* Constrain title bar to window width */
        .window.draggable .title-bar {
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* Title bar text truncation for narrow windows */
        .window.draggable .title-bar-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
            flex: 1;
        }

        /* Ensure title bar buttons don't shrink */
        .window.draggable .title-bar-controls {
            flex-shrink: 0;
        }

        /* Draggable window styles */
        .window.draggable {
            position: absolute;
            cursor: default;
            overflow: hidden;
        }

        .window.draggable .title-bar {
            cursor: move;
        }

        .window.draggable.maximized .title-bar {
            cursor: default;
        }

        /* Resize handles */
        .window.draggable .resize-handle {
            position: absolute;
            background: transparent;
        }

        .window.draggable .resize-handle.n {
            top: -3px;
            left: 3px;
            right: 3px;
            height: 6px;
            cursor: n-resize;
        }

        .window.draggable .resize-handle.s {
            bottom: -3px;
            left: 3px;
            right: 3px;
            height: 6px;
            cursor: s-resize;
        }

        .window.draggable .resize-handle.e {
            right: -3px;
            top: 3px;
            bottom: 3px;
            width: 6px;
            cursor: e-resize;
        }

        .window.draggable .resize-handle.w {
            left: -3px;
            top: 3px;
            bottom: 3px;
            width: 6px;
            cursor: w-resize;
        }

        .window.draggable .resize-handle.nw {
            top: -3px;
            left: -3px;
            width: 8px;
            height: 8px;
            cursor: nw-resize;
        }

        .window.draggable .resize-handle.ne {
            top: -3px;
            right: -3px;
            width: 8px;
            height: 8px;
            cursor: ne-resize;
        }

        .window.draggable .resize-handle.sw {
            bottom: -3px;
            left: -3px;
            width: 8px;
            height: 8px;
            cursor: sw-resize;
        }

        .window.draggable .resize-handle.se {
            bottom: -3px;
            right: -3px;
            width: 8px;
            height: 8px;
            cursor: se-resize;
        }

        /* Hide resize handles when maximized */
        .window.draggable.maximized .resize-handle {
            display: none;
        }

        /* Minimized window hidden */
        .window.draggable.minimized {
            display: none;
        }

        /* Demo info panel */
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 260px;
            background: #ffffcc;
            border: 1px solid #cccc00;
            padding: 12px;
            font-size: 12px;
            z-index: 1000;
        }

        .info-panel h3 {
            margin: 0 0 8px 0;
            font-size: 12px;
        }

        .info-panel ul {
            margin: 0;
            padding-left: 16px;
        }

        .info-panel li {
            margin-bottom: 4px;
        }

        .info-panel code {
            background: #fff;
            padding: 1px 3px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="desktop-container" id="desktop">
        <!-- Info panel -->
        <div class="info-panel">
            <h3>Window Behavior Demo</h3>
            <ul>
                <li><strong>Move:</strong> Drag title bar</li>
                <li><strong>Resize:</strong> Drag window edges</li>
                <li><strong>Minimize:</strong> Click ▼ → icon on desktop</li>
                <li><strong>Maximize:</strong> Click ▲ button</li>
                <li><strong>Restore:</strong> Click icon or ▲ on maximized</li>
                <li><strong>Close:</strong> Double-click system menu</li>
                <li><strong>Focus:</strong> Click anywhere on window</li>
                <li><strong>Drag icon:</strong> Snaps to grid</li>
                <li><strong>Arrange:</strong> Right-click desktop</li>
            </ul>
        </div>

        <!-- Test Window 1: Notepad -->
        <div class="window draggable active" id="window-notepad"
             style="left: 50px; top: 50px; width: 350px; height: 250px;"
             data-restore-left="50" data-restore-top="50"
             data-restore-width="350" data-restore-height="250">
            <div class="resize-handle n"></div>
            <div class="resize-handle s"></div>
            <div class="resize-handle e"></div>
            <div class="resize-handle w"></div>
            <div class="resize-handle nw"></div>
            <div class="resize-handle ne"></div>
            <div class="resize-handle sw"></div>
            <div class="resize-handle se"></div>
            <div class="title-bar">
                <div class="title-bar-controls">
                    <button class="system-menu" aria-label="System menu"></button>
                </div>
                <div class="title-bar-text">Notepad</div>
                <div class="title-bar-controls">
                    <button data-minimize aria-label="Minimize"></button>
                    <button data-maximize aria-label="Maximize"></button>
                </div>
            </div>
            <div class="window-body" style="height: calc(100% - 48px); position: relative;">
                <!-- Custom scrollable area with explicit scrollbars -->
                <div class="scroll-content">
                    <div class="scroll-viewport" id="notepad-viewport">
                        <div class="scroll-inner" id="notepad-content">
                            <p style="margin: 0; font-size: 12px;">
                                This is Notepad. Try dragging, resizing, minimizing, and maximizing this window.
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px;">
                                Windows operate within the gray desktop area and cannot extend beyond it.
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px;">
                                This window has enough content to demonstrate the Win3x styled scrollbars.
                                Resize the window smaller to see them appear.
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px;">
                                The scrollbars use 16x16px buttons with 3D beveled styling and arrow icons,
                                matching the authentic Windows 3.1 appearance.
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px;">
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod
                                tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam.
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px;">
                                Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore
                                eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident.
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px; white-space: nowrap;">
                                This line is intentionally long to demonstrate horizontal scrolling when the window is narrow enough ──────────────────────────────────────
                            </p>
                        </div>
                    </div>
                    <!-- Vertical scrollbar -->
                    <div class="scrollbar-v" id="notepad-scrollbar-v">
                        <div class="scroll-btn scroll-btn-up" data-direction="up">
                            <div class="scroll-arrow up"></div>
                        </div>
                        <div class="scroll-track">
                            <div class="scroll-thumb" id="notepad-thumb-v" style="top: 0; height: 40px;"></div>
                        </div>
                        <div class="scroll-btn scroll-btn-down" data-direction="down">
                            <div class="scroll-arrow down"></div>
                        </div>
                    </div>
                    <!-- Horizontal scrollbar -->
                    <div class="scrollbar-h" id="notepad-scrollbar-h">
                        <div class="scroll-btn scroll-btn-left" data-direction="left">
                            <div class="scroll-arrow left"></div>
                        </div>
                        <div class="scroll-track">
                            <div class="scroll-thumb" id="notepad-thumb-h" style="left: 0; width: 40px;"></div>
                        </div>
                        <div class="scroll-btn scroll-btn-right" data-direction="right">
                            <div class="scroll-arrow right"></div>
                        </div>
                    </div>
                    <!-- Corner piece -->
                    <div class="scroll-corner"></div>
                </div>
            </div>
            <!-- Status bar -->
            <div class="status-bar">
                <div class="status-bar-section">Ln 1, Col 1</div>
                <div class="status-bar-section">100%</div>
                <div class="sizing-grip"></div>
            </div>
        </div>

        <!-- Test Window 2: Calculator -->
        <div class="window draggable" id="window-calculator"
             style="left: 200px; top: 150px; width: 200px; height: 180px;"
             data-restore-left="200" data-restore-top="150"
             data-restore-width="200" data-restore-height="180">
            <div class="resize-handle n"></div>
            <div class="resize-handle s"></div>
            <div class="resize-handle e"></div>
            <div class="resize-handle w"></div>
            <div class="resize-handle nw"></div>
            <div class="resize-handle ne"></div>
            <div class="resize-handle sw"></div>
            <div class="resize-handle se"></div>
            <div class="title-bar">
                <div class="title-bar-controls">
                    <button class="system-menu" aria-label="System menu"></button>
                </div>
                <div class="title-bar-text">Calculator</div>
                <div class="title-bar-controls">
                    <button data-minimize aria-label="Minimize"></button>
                    <button data-maximize aria-label="Maximize"></button>
                </div>
            </div>
            <div class="window-body" style="height: calc(100% - 48px); position: relative;">
                <div class="scroll-content">
                    <div class="scroll-viewport" id="calc-viewport">
                        <div class="scroll-inner" id="calc-content">
                            <p style="margin: 0; font-size: 12px;">
                                A second window. Click to bring to front.
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px;">
                                Calculator content with scrollbars.
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px;">
                                7 8 9 /<br>
                                4 5 6 *<br>
                                1 2 3 -<br>
                                0 . = +
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px;">
                                Memory: M+ M- MR MC
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px;">
                                Additional content to ensure scrolling works properly in this window.
                            </p>
                        </div>
                    </div>
                    <!-- Vertical scrollbar -->
                    <div class="scrollbar-v" id="calc-scrollbar-v">
                        <div class="scroll-btn scroll-btn-up" data-direction="up">
                            <div class="scroll-arrow up"></div>
                        </div>
                        <div class="scroll-track">
                            <div class="scroll-thumb" id="calc-thumb-v" style="top: 0; height: 40px;"></div>
                        </div>
                        <div class="scroll-btn scroll-btn-down" data-direction="down">
                            <div class="scroll-arrow down"></div>
                        </div>
                    </div>
                    <!-- Horizontal scrollbar -->
                    <div class="scrollbar-h" id="calc-scrollbar-h">
                        <div class="scroll-btn scroll-btn-left" data-direction="left">
                            <div class="scroll-arrow left"></div>
                        </div>
                        <div class="scroll-track">
                            <div class="scroll-thumb" id="calc-thumb-h" style="left: 0; width: 40px;"></div>
                        </div>
                        <div class="scroll-btn scroll-btn-right" data-direction="right">
                            <div class="scroll-arrow right"></div>
                        </div>
                    </div>
                    <!-- Corner piece -->
                    <div class="scroll-corner"></div>
                </div>
            </div>
            <!-- Status bar -->
            <div class="status-bar">
                <div class="status-bar-section">Ready</div>
                <div class="sizing-grip"></div>
            </div>
        </div>

        <!-- Test Window 3: File Manager -->
        <div class="window draggable" id="window-filemanager"
             style="left: 350px; top: 80px; width: 300px; height: 200px;"
             data-restore-left="350" data-restore-top="80"
             data-restore-width="300" data-restore-height="200">
            <div class="resize-handle n"></div>
            <div class="resize-handle s"></div>
            <div class="resize-handle e"></div>
            <div class="resize-handle w"></div>
            <div class="resize-handle nw"></div>
            <div class="resize-handle ne"></div>
            <div class="resize-handle sw"></div>
            <div class="resize-handle se"></div>
            <div class="title-bar">
                <div class="title-bar-controls">
                    <button class="system-menu" aria-label="System menu"></button>
                </div>
                <div class="title-bar-text">File Manager</div>
                <div class="title-bar-controls">
                    <button data-minimize aria-label="Minimize"></button>
                    <button data-maximize aria-label="Maximize"></button>
                </div>
            </div>
            <div class="window-body" style="height: calc(100% - 48px); position: relative;">
                <div class="scroll-content">
                    <div class="scroll-viewport" id="filemgr-viewport">
                        <div class="scroll-inner" id="filemgr-content">
                            <p style="margin: 0; font-size: 12px;">
                                Third window for testing z-order and focus management.
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px;">
                                <strong>Directory of C:\WINDOWS</strong>
                            </p>
                            <p style="margin: 4px 0 0 0; font-size: 11px; font-family: monospace;">
                                SYSTEM.INI&nbsp;&nbsp;&nbsp;&nbsp;2,048<br>
                                WIN.INI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4,096<br>
                                NOTEPAD.EXE&nbsp;&nbsp;32,768<br>
                                CALC.EXE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;28,672<br>
                                WRITE.EXE&nbsp;&nbsp;&nbsp;&nbsp;45,056<br>
                                CLOCK.EXE&nbsp;&nbsp;&nbsp;&nbsp;16,384<br>
                                TERMINAL.EXE&nbsp;65,536<br>
                                CARDFILE.EXE&nbsp;24,576<br>
                                CALENDAR.EXE&nbsp;20,480<br>
                                PAINTBRUSH.EXE&nbsp;98,304
                            </p>
                            <p style="margin: 8px 0 0 0; font-size: 12px;">
                                10 file(s)&nbsp;&nbsp;&nbsp;337,920 bytes free
                            </p>
                        </div>
                    </div>
                    <!-- Vertical scrollbar -->
                    <div class="scrollbar-v" id="filemgr-scrollbar-v">
                        <div class="scroll-btn scroll-btn-up" data-direction="up">
                            <div class="scroll-arrow up"></div>
                        </div>
                        <div class="scroll-track">
                            <div class="scroll-thumb" id="filemgr-thumb-v" style="top: 0; height: 40px;"></div>
                        </div>
                        <div class="scroll-btn scroll-btn-down" data-direction="down">
                            <div class="scroll-arrow down"></div>
                        </div>
                    </div>
                    <!-- Horizontal scrollbar -->
                    <div class="scrollbar-h" id="filemgr-scrollbar-h">
                        <div class="scroll-btn scroll-btn-left" data-direction="left">
                            <div class="scroll-arrow left"></div>
                        </div>
                        <div class="scroll-track">
                            <div class="scroll-thumb" id="filemgr-thumb-h" style="left: 0; width: 40px;"></div>
                        </div>
                        <div class="scroll-btn scroll-btn-right" data-direction="right">
                            <div class="scroll-arrow right"></div>
                        </div>
                    </div>
                    <!-- Corner piece -->
                    <div class="scroll-corner"></div>
                </div>
            </div>
            <!-- Status bar -->
            <div class="status-bar">
                <div class="status-bar-section">C:\WINDOWS</div>
                <div class="status-bar-section">10 file(s)</div>
                <div class="sizing-grip"></div>
            </div>
        </div>

    </div>

    <script>
        /**
         * Win3x Window Manager
         * Manages window state: move, resize, minimize, maximize, focus
         * MDI-style: minimized windows become icons in parent container
         */
        (function() {
            const desktop = document.getElementById('desktop');
            let highestZIndex = 10;
            let activeWindow = null;
            let dragState = null;

            // Icon grid configuration
            const ICON_WIDTH = 100;
            const ICON_HEIGHT = 32;
            const ICON_GAP = 8;
            const ICON_MARGIN = 8;  // Margin from edges

            // Initialize all windows
            function init() {
                const windows = document.querySelectorAll('.window.draggable');
                windows.forEach(win => {
                    setupWindow(win);
                });

                // Set initial active window
                const activeWin = document.querySelector('.window.draggable.active');
                if (activeWin) {
                    setActiveWindow(activeWin);
                }
            }

            function setupWindow(win) {
                const titleBar = win.querySelector('.title-bar');
                const minimizeBtn = win.querySelector('[data-minimize]');
                const maximizeBtn = win.querySelector('[data-maximize]');
                const systemMenu = win.querySelector('.system-menu');
                const resizeHandles = win.querySelectorAll('.resize-handle');

                // Title bar drag to move
                titleBar.addEventListener('mousedown', (e) => {
                    // Don't drag if clicking a button
                    if (e.target.tagName === 'BUTTON') return;
                    // Don't drag if maximized
                    if (win.classList.contains('maximized')) return;

                    setActiveWindow(win);
                    startDrag(e, win, 'move');
                });

                // Minimize button
                minimizeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    minimizeWindow(win);
                });

                // Maximize/Restore button
                maximizeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (win.classList.contains('maximized')) {
                        restoreWindow(win);
                    } else {
                        maximizeWindow(win);
                    }
                });

                // System menu double-click to close
                systemMenu.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    closeWindow(win);
                });

                // Resize handles
                resizeHandles.forEach(handle => {
                    handle.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        setActiveWindow(win);
                        const direction = Array.from(handle.classList).find(c =>
                            ['n', 's', 'e', 'w', 'nw', 'ne', 'sw', 'se'].includes(c)
                        );
                        startDrag(e, win, 'resize', direction);
                    });
                });

                // Click to focus
                win.addEventListener('mousedown', () => {
                    setActiveWindow(win);
                });
            }

            function setActiveWindow(win) {
                // Remove active from all windows
                document.querySelectorAll('.window.draggable').forEach(w => {
                    w.classList.remove('active');
                });

                // Set this window active
                win.classList.add('active');
                highestZIndex++;
                win.style.zIndex = highestZIndex;
                activeWindow = win;
            }

            function startDrag(e, win, type, direction = null) {
                e.preventDefault();

                const rect = win.getBoundingClientRect();
                const desktopRect = desktop.getBoundingClientRect();

                dragState = {
                    type,
                    direction,
                    win,
                    startX: e.clientX,
                    startY: e.clientY,
                    startLeft: rect.left - desktopRect.left,
                    startTop: rect.top - desktopRect.top,
                    startWidth: rect.width,
                    startHeight: rect.height,
                    desktopWidth: desktopRect.width,
                    desktopHeight: desktopRect.height,
                    minWidth: 80,   // Just enough for title bar buttons
                    minHeight: 70   // Title bar + status bar + minimal content
                };

                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', endDrag);
            }

            function onDrag(e) {
                if (!dragState) return;

                const dx = e.clientX - dragState.startX;
                const dy = e.clientY - dragState.startY;
                const win = dragState.win;

                if (dragState.type === 'move') {
                    let newLeft = dragState.startLeft + dx;
                    let newTop = dragState.startTop + dy;

                    // Constrain to desktop (allow partial off-screen)
                    const minVisible = 40;
                    newLeft = Math.max(-win.offsetWidth + minVisible,
                              Math.min(newLeft, dragState.desktopWidth - minVisible));
                    newTop = Math.max(0,
                             Math.min(newTop, dragState.desktopHeight - minVisible));

                    win.style.left = newLeft + 'px';
                    win.style.top = newTop + 'px';
                }
                else if (dragState.type === 'resize') {
                    let newLeft = dragState.startLeft;
                    let newTop = dragState.startTop;
                    let newWidth = dragState.startWidth;
                    let newHeight = dragState.startHeight;
                    const dir = dragState.direction;

                    // Horizontal resize
                    if (dir.includes('e')) {
                        newWidth = Math.max(dragState.minWidth, dragState.startWidth + dx);
                        newWidth = Math.min(newWidth, dragState.desktopWidth - newLeft);
                    }
                    if (dir.includes('w')) {
                        const maxDx = dragState.startWidth - dragState.minWidth;
                        const actualDx = Math.max(-dragState.startLeft, Math.min(dx, maxDx));
                        newLeft = dragState.startLeft + actualDx;
                        newWidth = dragState.startWidth - actualDx;
                    }

                    // Vertical resize
                    if (dir.includes('s')) {
                        newHeight = Math.max(dragState.minHeight, dragState.startHeight + dy);
                        newHeight = Math.min(newHeight, dragState.desktopHeight - newTop);
                    }
                    if (dir.includes('n')) {
                        const maxDy = dragState.startHeight - dragState.minHeight;
                        const actualDy = Math.max(-dragState.startTop, Math.min(dy, maxDy));
                        newTop = dragState.startTop + actualDy;
                        newHeight = dragState.startHeight - actualDy;
                    }

                    win.style.left = newLeft + 'px';
                    win.style.top = newTop + 'px';
                    win.style.width = newWidth + 'px';
                    win.style.height = newHeight + 'px';
                }
            }

            function endDrag() {
                if (dragState && dragState.type !== 'move') {
                    // Save restore position after resize
                    const win = dragState.win;
                    if (!win.classList.contains('maximized')) {
                        saveRestoreState(win);
                    }
                }
                dragState = null;
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', endDrag);
            }

            function saveRestoreState(win) {
                win.dataset.restoreLeft = parseInt(win.style.left);
                win.dataset.restoreTop = parseInt(win.style.top);
                win.dataset.restoreWidth = parseInt(win.style.width);
                win.dataset.restoreHeight = parseInt(win.style.height);
            }

            // Get next available grid position for an icon
            function getNextIconPosition() {
                const existingIcons = desktop.querySelectorAll('.window-icon');
                const desktopRect = desktop.getBoundingClientRect();
                const cols = Math.floor((desktopRect.width - ICON_MARGIN * 2) / (ICON_WIDTH + ICON_GAP));

                // Find occupied positions
                const occupied = new Set();
                existingIcons.forEach(icon => {
                    const col = Math.round((parseInt(icon.style.left) - ICON_MARGIN) / (ICON_WIDTH + ICON_GAP));
                    const row = Math.round((desktopRect.height - parseInt(icon.style.top) - ICON_HEIGHT - ICON_MARGIN) / (ICON_HEIGHT + ICON_GAP));
                    occupied.add(`${col},${row}`);
                });

                // Find first available position (bottom-left, filling right then up)
                for (let row = 0; row < 100; row++) {
                    for (let col = 0; col < cols; col++) {
                        if (!occupied.has(`${col},${row}`)) {
                            return {
                                left: ICON_MARGIN + col * (ICON_WIDTH + ICON_GAP),
                                top: desktopRect.height - ICON_MARGIN - ICON_HEIGHT - row * (ICON_HEIGHT + ICON_GAP)
                            };
                        }
                    }
                }
                return { left: ICON_MARGIN, top: desktopRect.height - ICON_MARGIN - ICON_HEIGHT };
            }

            // Snap position to grid
            function snapToGrid(left, top) {
                const desktopRect = desktop.getBoundingClientRect();
                const col = Math.round((left - ICON_MARGIN) / (ICON_WIDTH + ICON_GAP));
                const row = Math.round((desktopRect.height - top - ICON_HEIGHT - ICON_MARGIN) / (ICON_HEIGHT + ICON_GAP));

                const cols = Math.floor((desktopRect.width - ICON_MARGIN * 2) / (ICON_WIDTH + ICON_GAP));
                const clampedCol = Math.max(0, Math.min(col, cols - 1));
                const clampedRow = Math.max(0, row);

                return {
                    left: ICON_MARGIN + clampedCol * (ICON_WIDTH + ICON_GAP),
                    top: desktopRect.height - ICON_MARGIN - ICON_HEIGHT - clampedRow * (ICON_HEIGHT + ICON_GAP)
                };
            }

            function minimizeWindow(win) {
                // Save current state if not maximized
                if (!win.classList.contains('maximized')) {
                    saveRestoreState(win);
                }

                // Create icon on desktop
                const title = win.querySelector('.title-bar-text').textContent;
                const pos = getNextIconPosition();

                const icon = document.createElement('div');
                icon.className = 'window-icon';
                icon.dataset.windowId = win.id;
                icon.style.left = pos.left + 'px';
                icon.style.top = pos.top + 'px';
                icon.innerHTML = `
                    <div class="icon-symbol"></div>
                    <span class="icon-title">${title}</span>
                `;

                // Click to restore
                icon.addEventListener('click', (e) => {
                    if (!icon.classList.contains('was-dragged')) {
                        restoreFromMinimize(win);
                    }
                    icon.classList.remove('was-dragged');
                });

                // Drag icon
                icon.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    startIconDrag(e, icon);
                });

                desktop.appendChild(icon);

                // Hide window
                win.classList.add('minimized');

                // Activate next window if this was active
                if (win === activeWindow) {
                    const visibleWindows = Array.from(
                        document.querySelectorAll('.window.draggable:not(.minimized)')
                    ).sort((a, b) => (parseInt(b.style.zIndex) || 0) - (parseInt(a.style.zIndex) || 0));

                    if (visibleWindows.length > 0) {
                        setActiveWindow(visibleWindows[0]);
                    } else {
                        activeWindow = null;
                    }
                }
            }

            function startIconDrag(e, icon) {
                const startX = e.clientX;
                const startY = e.clientY;
                const startLeft = parseInt(icon.style.left);
                const startTop = parseInt(icon.style.top);
                let hasMoved = false;

                function onMove(e) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;

                    if (Math.abs(dx) > 3 || Math.abs(dy) > 3) {
                        hasMoved = true;
                        icon.classList.add('dragging');
                        icon.style.left = (startLeft + dx) + 'px';
                        icon.style.top = (startTop + dy) + 'px';
                    }
                }

                function onUp() {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    icon.classList.remove('dragging');

                    if (hasMoved) {
                        icon.classList.add('was-dragged');
                        // Snap to grid
                        const snapped = snapToGrid(parseInt(icon.style.left), parseInt(icon.style.top));
                        icon.style.left = snapped.left + 'px';
                        icon.style.top = snapped.top + 'px';
                    }
                }

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            }

            function restoreFromMinimize(win) {
                // Remove icon from desktop
                const icon = desktop.querySelector(`.window-icon[data-window-id="${win.id}"]`);
                if (icon) {
                    icon.remove();
                }

                // Show window
                win.classList.remove('minimized');
                setActiveWindow(win);
            }

            function maximizeWindow(win) {
                // Save current state
                if (!win.classList.contains('maximized')) {
                    saveRestoreState(win);
                }

                // Maximize to fill desktop
                win.classList.add('maximized');
                win.style.left = '0';
                win.style.top = '0';
                win.style.width = '100%';
                win.style.height = '100%';
            }

            function restoreWindow(win) {
                win.classList.remove('maximized');
                win.style.left = (win.dataset.restoreLeft || 50) + 'px';
                win.style.top = (win.dataset.restoreTop || 50) + 'px';
                win.style.width = (win.dataset.restoreWidth || 300) + 'px';
                win.style.height = (win.dataset.restoreHeight || 200) + 'px';
            }

            function closeWindow(win) {
                // Remove icon if minimized
                const icon = desktop.querySelector(`.window-icon[data-window-id="${win.id}"]`);
                if (icon) {
                    icon.remove();
                }

                // Remove window
                win.remove();

                // Activate next window
                const visibleWindows = Array.from(
                    document.querySelectorAll('.window.draggable:not(.minimized)')
                ).sort((a, b) => (parseInt(b.style.zIndex) || 0) - (parseInt(a.style.zIndex) || 0));

                if (visibleWindows.length > 0) {
                    setActiveWindow(visibleWindows[0]);
                } else {
                    activeWindow = null;
                }
            }

            // Arrange all icons in a neat grid
            function arrangeIcons() {
                const icons = Array.from(desktop.querySelectorAll('.window-icon'));
                const desktopRect = desktop.getBoundingClientRect();
                const cols = Math.floor((desktopRect.width - ICON_MARGIN * 2) / (ICON_WIDTH + ICON_GAP));

                icons.forEach((icon, index) => {
                    const col = index % cols;
                    const row = Math.floor(index / cols);
                    icon.style.left = (ICON_MARGIN + col * (ICON_WIDTH + ICON_GAP)) + 'px';
                    icon.style.top = (desktopRect.height - ICON_MARGIN - ICON_HEIGHT - row * (ICON_HEIGHT + ICON_GAP)) + 'px';
                });
            }

            // Right-click on desktop to arrange icons
            desktop.addEventListener('contextmenu', (e) => {
                // Only if clicking on desktop itself, not on a window or icon
                if (e.target === desktop || e.target.classList.contains('desktop-container')) {
                    e.preventDefault();
                    arrangeIcons();
                }
            });

            // ============================================
            // Custom Scrollbar Management
            // ============================================

            function initScrollbar(viewportId, contentId, vScrollbarId, hScrollbarId, vThumbId, hThumbId) {
                const viewport = document.getElementById(viewportId);
                const content = document.getElementById(contentId);
                const vScrollbar = document.getElementById(vScrollbarId);
                const hScrollbar = document.getElementById(hScrollbarId);
                const vThumb = document.getElementById(vThumbId);
                const hThumb = document.getElementById(hThumbId);

                if (!viewport || !content) return;

                let scrollTop = 0;
                let scrollLeft = 0;
                let autoRepeatTimer = null;
                let autoRepeatInterval = null;

                const SCROLL_LINE = 20;  // Pixels per arrow click
                const SCROLL_PAGE = 100; // Pixels per track click
                const AUTO_REPEAT_DELAY = 400;  // ms before auto-repeat starts
                const AUTO_REPEAT_RATE = 50;    // ms between repeats

                function updateScrollPosition() {
                    const maxScrollTop = Math.max(0, content.scrollHeight - viewport.clientHeight);
                    const maxScrollLeft = Math.max(0, content.scrollWidth - viewport.clientWidth);

                    scrollTop = Math.max(0, Math.min(scrollTop, maxScrollTop));
                    scrollLeft = Math.max(0, Math.min(scrollLeft, maxScrollLeft));

                    content.style.transform = `translate(${-scrollLeft}px, ${-scrollTop}px)`;

                    // Update thumb positions
                    updateThumbs(maxScrollTop, maxScrollLeft);
                }

                function updateThumbs(maxScrollTop, maxScrollLeft) {
                    if (vThumb && vScrollbar) {
                        const track = vScrollbar.querySelector('.scroll-track');
                        if (track && maxScrollTop > 0) {
                            const trackHeight = track.clientHeight;
                            const thumbHeight = Math.max(20, (viewport.clientHeight / content.scrollHeight) * trackHeight);
                            const thumbTop = (scrollTop / maxScrollTop) * (trackHeight - thumbHeight);
                            vThumb.style.height = thumbHeight + 'px';
                            vThumb.style.top = thumbTop + 'px';
                        }
                    }

                    if (hThumb && hScrollbar) {
                        const track = hScrollbar.querySelector('.scroll-track');
                        if (track && maxScrollLeft > 0) {
                            const trackWidth = track.clientWidth;
                            const thumbWidth = Math.max(20, (viewport.clientWidth / content.scrollWidth) * trackWidth);
                            const thumbLeft = (scrollLeft / maxScrollLeft) * (trackWidth - thumbWidth);
                            hThumb.style.width = thumbWidth + 'px';
                            hThumb.style.left = thumbLeft + 'px';
                        }
                    }
                }

                function scrollBy(dx, dy) {
                    scrollTop += dy;
                    scrollLeft += dx;
                    updateScrollPosition();
                }

                function startAutoRepeat(dx, dy) {
                    stopAutoRepeat();
                    scrollBy(dx, dy);

                    autoRepeatTimer = setTimeout(() => {
                        autoRepeatInterval = setInterval(() => {
                            scrollBy(dx, dy);
                        }, AUTO_REPEAT_RATE);
                    }, AUTO_REPEAT_DELAY);
                }

                function stopAutoRepeat() {
                    if (autoRepeatTimer) {
                        clearTimeout(autoRepeatTimer);
                        autoRepeatTimer = null;
                    }
                    if (autoRepeatInterval) {
                        clearInterval(autoRepeatInterval);
                        autoRepeatInterval = null;
                    }
                }

                // Vertical scrollbar buttons
                if (vScrollbar) {
                    const upBtn = vScrollbar.querySelector('[data-direction="up"]');
                    const downBtn = vScrollbar.querySelector('[data-direction="down"]');

                    if (upBtn) {
                        upBtn.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            startAutoRepeat(0, -SCROLL_LINE);
                        });
                    }
                    if (downBtn) {
                        downBtn.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            startAutoRepeat(0, SCROLL_LINE);
                        });
                    }
                }

                // Horizontal scrollbar buttons
                if (hScrollbar) {
                    const leftBtn = hScrollbar.querySelector('[data-direction="left"]');
                    const rightBtn = hScrollbar.querySelector('[data-direction="right"]');

                    if (leftBtn) {
                        leftBtn.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            startAutoRepeat(-SCROLL_LINE, 0);
                        });
                    }
                    if (rightBtn) {
                        rightBtn.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            startAutoRepeat(SCROLL_LINE, 0);
                        });
                    }
                }

                // Stop auto-repeat on mouseup anywhere
                document.addEventListener('mouseup', stopAutoRepeat);

                // Initial update
                updateScrollPosition();

                // Update on window resize
                window.addEventListener('resize', () => {
                    updateScrollPosition();
                });

                // Return controller for external access if needed
                return {
                    scrollBy,
                    updateScrollPosition
                };
            }

            // Initialize all scrollbars
            function initAllScrollbars() {
                // Notepad
                initScrollbar(
                    'notepad-viewport', 'notepad-content',
                    'notepad-scrollbar-v', 'notepad-scrollbar-h',
                    'notepad-thumb-v', 'notepad-thumb-h'
                );
                // Calculator
                initScrollbar(
                    'calc-viewport', 'calc-content',
                    'calc-scrollbar-v', 'calc-scrollbar-h',
                    'calc-thumb-v', 'calc-thumb-h'
                );
                // File Manager
                initScrollbar(
                    'filemgr-viewport', 'filemgr-content',
                    'filemgr-scrollbar-v', 'filemgr-scrollbar-h',
                    'filemgr-thumb-v', 'filemgr-thumb-h'
                );
            }

            // Initialize on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    init();
                    initAllScrollbars();
                });
            } else {
                init();
                initAllScrollbars();
            }
        })();
    </script>
</body>
</html>
